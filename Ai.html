<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .chat-message.user {
            background-color: #e2f4ff;
        }
        .chat-message.ai {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Main Application Container -->
    <div class="bg-white rounded-xl shadow-2xl overflow-hidden flex flex-col w-full max-w-2xl h-[90vh]">

        <!-- Header -->
        <header class="bg-indigo-600 text-white p-4 flex items-center justify-between">
            <h1 class="text-xl font-bold">Gen AI Chatbot</h1>
        </header>

        <!-- Chat Container -->
        <main id="chat-container" class="flex-grow p-4 overflow-y-auto space-y-4">
            <!-- Messages will be injected here by JavaScript -->
        </main>

        <!-- Input Area -->
        <div class="p-4 border-t border-gray-200">
            <div id="status-message" class="text-gray-500 text-sm mb-2 h-5"></div>
            <div class="flex items-center space-x-2">
                <input
                    id="user-input"
                    type="text"
                    class="flex-grow p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all"
                    placeholder="Ask a question or request an image (e.g., 'An image of a futuristic city')..."
                    aria-label="User input for chat"
                />
                <button
                    id="send-button"
                    class="bg-indigo-600 text-white p-3 rounded-full hover:bg-indigo-700 transition-all transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    aria-label="Send message"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12zm0 0h7.5" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading-spinner" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 p-4 rounded-full shadow-lg z-50">
        <div class="w-12 h-12 border-4 border-t-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // API configurations
            const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=";
            const IMAGE_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=";
            const apiKey = ""; // API key is handled by the environment. Do not modify.

            const chatContainer = document.getElementById('chat-container');
            const userInput = document.getElementById('user-input');
            const sendButton = document.getElementById('send-button');
            const statusMessage = document.getElementById('status-message');
            const loadingSpinner = document.getElementById('loading-spinner');

            const VIDEO_KEYWORDS = ['video of', 'generate a video', 'create a video', 'make a video', 'video about'];

            // Function to add a message to the chat interface
            function addMessageToChat(message, sender, type = 'text') {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('chat-message', 'p-3', 'rounded-xl', 'max-w-[85%]', 'break-words', 'shadow-sm');

                if (sender === 'user') {
                    messageDiv.classList.add('user', 'self-end', 'ml-auto');
                } else {
                    messageDiv.classList.add('ai', 'self-start', 'mr-auto');
                }

                if (type === 'image') {
                    const img = document.createElement('img');
                    img.src = message;
                    img.alt = 'Generated image';
                    img.classList.add('rounded-lg', 'w-full', 'h-auto', 'object-cover');
                    messageDiv.appendChild(img);
                } else {
                    messageDiv.textContent = message;
                }

                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            // Handles the exponential backoff for API retries
            async function fetchWithBackoff(url, options, retries = 5, delay = 1000) {
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(url, options);
                        if (response.status === 429) {
                            // Too many requests, retry with exponential backoff
                            await new Promise(res => setTimeout(res, delay));
                            delay *= 2;
                            continue;
                        }
                        return response;
                    } catch (error) {
                        if (i === retries - 1) {
                            throw error;
                        }
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                    }
                }
                throw new Error('Failed to fetch after multiple retries.');
            }

            // Function to handle image generation
            async function generateImage(prompt) {
                const payload = {
                    instances: { prompt: prompt },
                    parameters: { "sampleCount": 1 }
                };

                const options = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                };

                statusMessage.textContent = 'Generating image...';
                showLoading(true);

                try {
                    const response = await fetchWithBackoff(IMAGE_API_URL + apiKey, options);
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API Error: ${response.status} - ${JSON.stringify(errorData)}`);
                    }
                    const result = await response.json();
                    const base64Data = result?.predictions?.[0]?.bytesBase64Encoded;
                    if (base64Data) {
                        const imageUrl = `data:image/png;base64,${base64Data}`;
                        addMessageToChat(imageUrl, 'ai', 'image');
                    } else {
                        addMessageToChat('Failed to generate image. Please try a different prompt.', 'ai');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    addMessageToChat('An error occurred while generating the image. Please try again.', 'ai');
                } finally {
                    statusMessage.textContent = '';
                    showLoading(false);
                    saveChatHistory();
                }
            }

            // Function to handle text generation (default)
            async function generateContent(prompt) {
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    tools: [{ "google_search": {} }],
                };

                const options = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                };

                statusMessage.textContent = 'Thinking...';
                showLoading(true);

                try {
                    const response = await fetchWithBackoff(GEMINI_API_URL + apiKey, options);
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API Error: ${response.status} - ${JSON.stringify(errorData)}`);
                    }
                    const result = await response.json();
                    const aiText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (aiText) {
                        addMessageToChat(aiText, 'ai');
                    } else {
                        addMessageToChat('I could not generate a response. Please try again.', 'ai');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    addMessageToChat('An error occurred. Please try again.', 'ai');
                } finally {
                    statusMessage.textContent = '';
                    showLoading(false);
                    saveChatHistory();
                }
            }

            function showLoading(show) {
                loadingSpinner.classList.toggle('hidden', !show);
                sendButton.disabled = show;
                userInput.disabled = show;
            }

            // Main function to handle user input
            function handleUserInput() {
                const prompt = userInput.value.trim();
                if (!prompt) return;

                addMessageToChat(prompt, 'user');
                userInput.value = '';

                const lowerPrompt = prompt.toLowerCase();
                const isImageRequest = lowerPrompt.includes('image of') || lowerPrompt.includes('generate an image') || lowerPrompt.includes('create a picture') || lowerPrompt.startsWith('an image of');
                const isVideoRequest = VIDEO_KEYWORDS.some(keyword => lowerPrompt.includes(keyword));

                if (isVideoRequest) {
                    addMessageToChat("I'm sorry, I cannot generate videos at this time. Video generation is a very complex and resource-intensive task. Please try a different request, such as generating an image.", 'ai');
                    saveChatHistory();
                } else if (isImageRequest) {
                    generateImage(prompt);
                } else {
                    generateContent(prompt);
                }
            }

            // Save and load chat history
            function saveChatHistory() {
                const messages = [];
                const messageElements = chatContainer.querySelectorAll('.chat-message');
                messageElements.forEach(el => {
                    const sender = el.classList.contains('user') ? 'user' : 'ai';
                    const type = el.querySelector('img') ? 'image' : 'text';
                    const content = type === 'image' ? el.querySelector('img').src : el.textContent;
                    messages.push({ sender, type, content });
                });
                localStorage.setItem('chatHistory', JSON.stringify(messages));
            }

            function loadChatHistory() {
                const history = localStorage.getItem('chatHistory');
                if (history) {
                    try {
                        const messages = JSON.parse(history);
                        messages.forEach(msg => {
                            addMessageToChat(msg.content, msg.sender, msg.type);
                        });
                    } catch (e) {
                        console.error("Failed to parse chat history from localStorage", e);
                        // Clear corrupted history
                        localStorage.removeItem('chatHistory');
                    }
                }
            }

            // Event listeners
            sendButton.addEventListener('click', handleUserInput);
            userInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    handleUserInput();
                }
            });

            // Initial load
            loadChatHistory();
        });
    </script>
</body>
</html>
